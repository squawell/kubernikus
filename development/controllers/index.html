<!DOCTYPE html>
  
  
  
  
   <html class="no-js"> 

  <head lang="en-us">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,maximum-scale=1">
    <meta http-equiv="X-UA-Compatible" content="IE=10" />
    <title> - Kubernikus</title>
    <meta name="generator" content="Hugo 0.30.2" />

    
    <link rel="canonical" href="/kubernikus/development/controllers/">
    

    <meta property="og:url" content="/kubernikus/development/controllers/">
    <meta property="og:title" content="Kubernikus">
    <meta property="og:image" content="/kubernikus/images/logo.png">
    <meta name="apple-mobile-web-app-title" content="Kubernikus">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <link rel="shortcut icon" type="image/x-icon" href="/kubernikus/images/favicon.ico">
    <link rel="icon" type="image/x-icon" href="/kubernikus/images/favicon.ico">

    <style>
      @font-face {
        font-family: 'Icon';
        src: url('/kubernikus/fonts/icon.eot');
        src: url('/kubernikus/fonts/icon.eot')
               format('embedded-opentype'),
             url('/kubernikus/fonts/icon.woff')
               format('woff'),
             url('/kubernikus/fonts/icon.ttf')
               format('truetype'),
             url('/kubernikus/fonts/icon.svg')
               format('svg');
        font-weight: normal;
        font-style: normal;
      }
    </style>

    <link rel="stylesheet" href="/kubernikus/stylesheets/application.css">
    <link rel="stylesheet" href="/kubernikus/stylesheets/temporary.css">
    <link rel="stylesheet" href="/kubernikus/stylesheets/palettes.css">
    <link rel="stylesheet" href="/kubernikus/stylesheets/highlight/highlight.css">

    
    
    
    <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Ubuntu:400,700|Ubuntu&#43;Mono">
    <style>
      body, input {
        font-family: 'Ubuntu', Helvetica, Arial, sans-serif;
      }
      pre, code {
        font-family: 'Ubuntu Mono', 'Courier New', 'Courier', monospace;
      }
    </style>

    
    <link rel="stylesheet" href="/kubernikus/stylesheets/hacks.css">
    
    
    <script src="/kubernikus/javascripts/modernizr.js"></script>

    

  </head>
  <body class="palette-primary-blue palette-accent-teal">



	
	


<div class="backdrop">
	<div class="backdrop-paper"></div>
</div>

<input class="toggle" type="checkbox" id="toggle-drawer">
<input class="toggle" type="checkbox" id="toggle-search">
<label class="toggle-button overlay" for="toggle-drawer"></label>

<header class="header">
	<nav aria-label="Header">
  <div class="bar default">
    <div class="button button-menu" role="button" aria-label="Menu">
      <label class="toggle-button icon icon-menu" for="toggle-drawer">
        <span></span>
      </label>
    </div>
    <div class="stretch">
      <div class="title">
        
      </div>
    </div>

    

    
    <div class="button button-github" role="button" aria-label="GitHub">
      <a href="https://github.com/sapcc/kubernikus" title="@sapcc/kubernikus on GitHub" target="_blank" class="toggle-button icon icon-github"></a>
    </div>
    
    
        
  </div>
  <div class="bar search">
    <div class="button button-close" role="button" aria-label="Close">
      <label class="toggle-button icon icon-back" for="toggle-search"></label>
    </div>
    <div class="stretch">
      <div class="field">
        <input class="query" type="text" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck>
      </div>
    </div>
    <div class="button button-reset" role="button" aria-label="Search">
      <button class="toggle-button icon icon-close" id="reset-search"></button>
    </div>
  </div>
</nav>
</header>

<main class="main">
	<div class="drawer">
		<nav aria-label="Navigation">
  <a href="https://github.com/sapcc/kubernikus" class="project">
    <div class="banner">
      
        <div class="logo">
          <img src="/kubernikus/images/logo.png">
        </div>
      
      <div class="name">
        <strong>Kubernikus </strong>
        
          <br>
          sapcc/kubernikus
        
      </div>
    </div>
  </a>

  <div class="scrollable">
    <div class="wrapper">
      
        <ul class="repo">
          <li class="repo-download">
            <a href="https://github.com/sapcc/kubernikus/archive/master.zip" target="_blank" title="Download" data-action="download">
              <i class="icon icon-download"></i> Download
            </a>
          </li>
          <li class="repo-stars">
            <a href="https://github.com/sapcc/kubernikus/stargazers" target="_blank" title="Stargazers" data-action="star">
              <i class="icon icon-star"></i> Stars
              <span class="count">&ndash;</span>
            </a>
          </li>
        </ul>
        <hr>
      

      <div class="toc">
        


<ul>
  
  <li>
    <a  href="/kubernikus/development/controllers/">Development</a>

    
    <ul class="anchor">
      
      <li class="anchor"><a class="current" href="/kubernikus/development/controllers/"></a></li>
      
      <li class="anchor"><a  href="/kubernikus/development/changing_docs/">Changing Docs</a></li>
      
      <li class="anchor"><a  href="/kubernikus/development/helm_dev/">Developing Helm Charts</a></li>
      
    </ul>
    
  </li>
  
  <li>
    <a  href="/kubernikus/guide/getting_started/">Guide</a>

    
  </li>
  
  <li>
    <a  href="/kubernikus/operations/controlplane/">Operations</a>

    
  </li>
  
</ul>


        
      </div>
    </div>
  </div>
</nav>

	</div>

	<article class="article">
		<div class="wrapper">
			<h1> </h1>

			

<h1 id="kubernikus-controllers">Kubernikus Controllers</h1>

<p>The Kubernikus operator contains various independent controllers each one handling a different aspect of the managed kubernetes clusters.</p>

<h2 id="deorbit-controller">Deorbit Controller</h2>

<p>The Kubernetes <code>controller-manager</code> runs controllers that are responsible for
creating, updating and deleting of OpenStack resources. It auto-provisions
Cinder volumes for Persistent Volume Claims, load balancers for services and
routes for nodes in the cluster.  When a kluster is terminated it is desired
that these resources are cleaned up automatically.</p>

<p>The problem is that the <code>controller-manager</code> only cleans up, when the
respective resources are deleted from the cluster.</p>

<p>This is where the <code>deorbiter</code> comes into play. It inspects the cluster and
deletes all PVCs that are backed by Cinder, as well as all services of type
<code>LoadBalancer</code>. Afterwards, it waits until the <code>controller-manager</code> has
completed the clean-up.</p>

<p>Problematic is that Cinder volumes can take a variable time until they are
deleted. In some cases volumes might be stuck deleting indefinitely. The
<code>deorbiter</code> watches the PVs (note: PV not PVC) in the cluster and waits for all
of them to disappear. PVs are guarded by a finalizer and are only removed when
the cleanup completes. The <code>deorbiter</code> retries the deletion for a configurable
amount of time and eventually self-destructs the cluster. This might leave some
debris in the OpenStack project.</p>

<p>For services Kubernetes does currently not implement the same finalizer
concept. That means that a service is deleted immediately while the clean-up
progresses in the background. Without double checking directly in OpenStack,
the <code>deboriter</code> can&rsquo;t tell when the deletion is completed. Here we assume
a fixed time, like 2 minutes, and hope for the best.</p>

<h2 id="route-garbage-collector">Route garbage collector</h2>

<p>The <code>routegc</code> controller is a stopgap solution to mitigate a bug in the official kubernetes OpenStack cloud provider (See <a href="https://github.com/kubernetes/kubernetes/pull/56258">kubernetes/kubernetes#56258</a>).
The bug occasionally leaves static route entries in the cluster&rsquo;s OpenStack router when a Node is deleted. This causes routing problems when a new Node is reusing the network segment for Pods.</p>

<p>The bug is fixed in the upcoming 1.10 version of kubernetes. That means this controller is only needed for clusters &lt;1.10.</p>

<p>For each cluster the controller polls the corresponding OpenStack router and inspects the configured static routes. It tries to identify and remove orphaned routes to fix the clusters networking. It removes all route entries for CIDR ranges that are within the clusters CIDR range for Pods where the target/nextHop ip address can&rsquo;t be matched to an OpenStack compute instance.</p>


			<aside class="copyright" role="note">
				
			</aside>

			<footer class="footer">
				

<nav class="pagination" aria-label="Footer">
  <div class="previous">
  
      <a href="/kubernikus/about/" title="">
        <span class="direction">
          Previous
        </span>
        <div class="page">
          <div class="button button-previous" role="button" aria-label="Previous">
            <i class="icon icon-back"></i>
          </div>
          <div class="stretch">
            <div class="title">
              
            </div>
          </div>
        </div>
      </a>
  
  </div>

  <div class="next">
  
      <a href="/kubernikus/features/" title="">
        <span class="direction">
          Next
        </span>
        <div class="page">
          <div class="stretch">
            <div class="title">
              
            </div>
          </div>
          <div class="button button-next" role="button" aria-label="Next">
            <i class="icon icon-forward"></i>
          </div>
        </div>
      </a>
  
  </div>
</nav>





			</footer>
		</div>
	</article>

	<div class="results" role="status" aria-live="polite">
		<div class="scrollable">
			<div class="wrapper">
				<div class="meta"></div>
				<div class="list"></div>
			</div>
		</div>
	</div>
</main>

    <script>
    
      var base_url = '\/kubernikus';
      var repo_id  = 'sapcc\/kubernikus';
    
    </script>

    <script src="/kubernikus/javascripts/application.js"></script>
    

    <script>
      /* Add headers to scrollspy */
      var headers   = document.getElementsByTagName("h2");
      var scrollspy = document.getElementById('scrollspy');

      if(scrollspy) {
        if(headers.length > 0) {
          for(var i = 0; i < headers.length; i++) {
            var li = document.createElement("li");
            li.setAttribute("class", "anchor");

            var a  = document.createElement("a");
            a.setAttribute("href", "#" + headers[i].id);
            a.setAttribute("title", headers[i].innerHTML);
            a.innerHTML = headers[i].innerHTML;

            li.appendChild(a)
            scrollspy.appendChild(li);
          }
        } else {
          scrollspy.parentElement.removeChild(scrollspy)
        }


        /* Add permanent link next to the headers */
        var headers = document.querySelectorAll("h1, h2, h3, h4, h5, h6");

        for(var i = 0; i < headers.length; i++) {
            var a = document.createElement("a");
            a.setAttribute("class", "headerlink");
            a.setAttribute("href", "#" + headers[i].id);
            a.setAttribute("title", "Permanent link")
            a.innerHTML = "#";
            headers[i].appendChild(a);
        }
      }
    </script>

    

    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.8.0/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
  </body>
</html>

